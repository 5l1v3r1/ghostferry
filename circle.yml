machine:
  environment:
    USERGOPATH: "/home/ubuntu/.go_workspace"

  services:
    - docker

test:
  override:
    - go test ./test ./reloc/test -p 1 -v

dependencies:
  post:
    - docker-compose up -d mysql-1 mysql-2
    - gem install package_cloud

deployment:
  production:
    branch: /master|staging-.*/
    commands:
      - mkdir -p "$USERGOPATH/src/github.com/$CIRCLE_PROJECT_USERNAME"
      - ln -sr "$(pwd)" "$USERGOPATH/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME"
      - make reloc-deb GOPATH="$USERGOPATH"
      - package_cloud push --url https://packages.shopify.io shopify/reloc/ubuntu/trusty build/reloc_*.deb
